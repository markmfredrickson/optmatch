<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create treated to control distances for matching problems — match_on • optmatch</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create treated to control distances for matching problems — match_on"><meta name="description" content="A function with which to produce matching distances, for instance Mahalanobis
distances, propensity score discrepancies or calipers, or combinations
thereof, for pairmatch or fullmatch to
subsequently &amp;#8220;match on&amp;#8221;.  Conceptually, the result of a call
match_on is a treatment-by-control matrix of distances.  Because these
matrices can grow quite large, in practice match_on produces either an
ordinary dense matrix or a special sparse matrix structure (that can make use
of caliper and exact matching constraints to reduce storage requirements).
Methods are supplied for these sparse structures,
InfinitySparseMatrixes, so that they can be manipulated and modified
in much the same way as dense matrices."><meta property="og:description" content="A function with which to produce matching distances, for instance Mahalanobis
distances, propensity score discrepancies or calipers, or combinations
thereof, for pairmatch or fullmatch to
subsequently &amp;#8220;match on&amp;#8221;.  Conceptually, the result of a call
match_on is a treatment-by-control matrix of distances.  Because these
matrices can grow quite large, in practice match_on produces either an
ordinary dense matrix or a special sparse matrix structure (that can make use
of caliper and exact matching constraints to reduce storage requirements).
Methods are supplied for these sparse structures,
InfinitySparseMatrixes, so that they can be manipulated and modified
in much the same way as dense matrices."><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">optmatch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.10.7.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/fullmatch-vignette.html">Matching in R using the optmatch package</a></li>
    <li><a class="dropdown-item" href="../articles/matching-from-foreign-software.html">Using Optmatch on data in SAS, Stata, etc</a></li>
    <li><a class="dropdown-item" href="../articles/matching-within-subgroups.html">Combining Matches Within Subgroups</a></li>
    <li><a class="dropdown-item" href="../articles/MCFSolutions.html">Classes and methods for min-cost flow solutions</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/markmfredrickson/optmatch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Create treated to control distances for matching problems</h1>
      <small class="dont-index">Source: <a href="https://github.com/markmfredrickson/optmatch/blob/master/R/match_on.R" class="external-link"><code>R/match_on.R</code></a></small>
      <div class="d-none name"><code>match_on-methods.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>A function with which to produce matching distances, for instance Mahalanobis
distances, propensity score discrepancies or calipers, or combinations
thereof, for <code><a href="pairmatch.html">pairmatch</a></code> or <code><a href="fullmatch.html">fullmatch</a></code> to
subsequently “match on”.  Conceptually, the result of a call
<code>match_on</code> is a treatment-by-control matrix of distances.  Because these
matrices can grow quite large, in practice <code>match_on</code> produces either an
ordinary dense matrix or a special sparse matrix structure (that can make use
of caliper and exact matching constraints to reduce storage requirements).
Methods are supplied for these sparse structures,
<code>InfinitySparseMatrix</code>es, so that they can be manipulated and modified
in much the same way as dense matrices.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">match_on</span><span class="op">(</span><span class="va">x</span>, within <span class="op">=</span> <span class="cn">NULL</span>, caliper <span class="op">=</span> <span class="cn">NULL</span>, exclude <span class="op">=</span> <span class="cn">NULL</span>, data <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'glm'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  within <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  caliper <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exclude <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  standardization.scale <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'bigglm'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  within <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  caliper <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exclude <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  standardization.scale <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'formula'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  within <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  caliper <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exclude <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  subset <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class '`function`'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  within <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  caliper <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exclude <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  z <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'numeric'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span><span class="va">x</span>, within <span class="op">=</span> <span class="cn">NULL</span>, caliper <span class="op">=</span> <span class="cn">NULL</span>, exclude <span class="op">=</span> <span class="cn">NULL</span>, data <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">z</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'InfinitySparseMatrix'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span><span class="va">x</span>, within <span class="op">=</span> <span class="cn">NULL</span>, caliper <span class="op">=</span> <span class="cn">NULL</span>, exclude <span class="op">=</span> <span class="cn">NULL</span>, data <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'matrix'</span></span>
<span><span class="fu">match_on</span><span class="op">(</span><span class="va">x</span>, within <span class="op">=</span> <span class="cn">NULL</span>, caliper <span class="op">=</span> <span class="cn">NULL</span>, exclude <span class="op">=</span> <span class="cn">NULL</span>, data <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A model formula, fitted glm or other object implicitly specifying a distance; see blurbs on specific methods in Details.</p></dd>


<dt id="arg-within">within<a class="anchor" aria-label="anchor" href="#arg-within"></a></dt>
<dd><p>A valid distance specification, such as the result of
<code><a href="exactMatch.html">exactMatch</a></code> or <code><a href="caliper-methods.html">caliper</a></code>. Finite entries indicate
which distances to create. Including this argument can significantly speed
up computation for sparse matching problems. Specify this filter either via
<code>within</code> or via <code>strata</code> elements of a formula; mixing these
methods will fail.</p></dd>


<dt id="arg-caliper">caliper<a class="anchor" aria-label="anchor" href="#arg-caliper"></a></dt>
<dd><p>The width of a caliper to use to exclude treated-control pairs
with values greater than the width. For some methods, there may be a speed
advantage to passing a width rather than using the <code><a href="caliper-methods.html">caliper</a></code>
function on an existing distance specification.</p></dd>


<dt id="arg-exclude">exclude<a class="anchor" aria-label="anchor" href="#arg-exclude"></a></dt>
<dd><p>A list of units (treated or control) to exclude from the
<code>caliper</code> argument (if supplied).</p></dd>


<dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>An optional data frame.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Other arguments for methods.</p></dd>


<dt id="arg-standardization-scale">standardization.scale<a class="anchor" aria-label="anchor" href="#arg-standardization-scale"></a></dt>
<dd><p>Function for rescaling of <code>scores(x)</code>, or
<code>NULL</code>; defaults to <code>mad</code>. (See Details.)</p></dd>


<dt id="arg-subset">subset<a class="anchor" aria-label="anchor" href="#arg-subset"></a></dt>
<dd><p>A subset of the data to use in creating the distance
specification.</p></dd>


<dt id="arg-method">method<a class="anchor" aria-label="anchor" href="#arg-method"></a></dt>
<dd><p>A string indicating which method to use in computing the
distances from the data.  The current possibilities are
<code>"mahalanobis", "euclidean"</code> or <code>"rank_mahalanobis"</code>.</p></dd>


<dt id="arg-z">z<a class="anchor" aria-label="anchor" href="#arg-z"></a></dt>
<dd><p>A logical or binary vector indicating treatment and control for each
unit in the study. TRUE or 1 represents a treatment unit, FALSE of 0 represents
a control unit. Any unit with NA treatment status will be excluded from the
distance matrix.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A distance specification (a matrix or similar object) which is
  suitable to be given as the <code>distance</code> argument to
  <code><a href="fullmatch.html">fullmatch</a></code> or <code><a href="pairmatch.html">pairmatch</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>match_on</code> is generic. There are several supplied methods, all providing
the same basic output: a matrix (or similar) object with treated units on the
rows and control units on the columns. Each cell [i,j] then indicates the
distance from a treated unit i to control unit j. Entries that are <code>Inf</code>
are said to be unmatchable. Such units are guaranteed to never be in a
matched set. For problems with many <code>Inf</code> entries, so called sparse
matching problems, <code>match_on</code> uses a special data type that is more
space efficient than a standard R <code>matrix</code>.  When problems are not
sparse (i.e. dense), <code>match_on</code> uses the standard <code>matrix</code> type.</p>
<p><code>match_on</code> methods differ on the types of arguments they take, making
the function a one-stop location of many different ways of specifying
matches: using functions, formulas, models, and even simple scores. Many of
the methods require additional arguments, detailed below. All methods take a
<code>within</code> argument, a distance specification made using
<code><a href="exactMatch.html">exactMatch</a></code> or <code><a href="caliper-methods.html">caliper</a></code> (or some additive
combination of these or other distance creating functions). All
<code>match_on</code> methods will use the finite entries in the <code>within</code>
argument as a guide for producing the new distance. Any entry that is
<code>Inf</code> in <code>within</code> will be <code>Inf</code> in the distance matrix
returned by <code>match_on</code>. This argument can reduce the processing time
needed to compute sparse distance matrices.</p>
<p>Details for each particular first type of argument follow:</p>
<p><b>First argument (<code>x</code>): <code>glm</code>.</b> The model is assumed to be
  a fitted propensity score model. From this it extracts distances on the
  <em>linear</em> propensity score: fitted values of the linear predictor, the
  link function applied to the estimated conditional probabilities, as opposed
  to the estimated conditional probabilities themselves (Rosenbaum &amp; Rubin,
  1985).  For example, a logistic model (<code>glm</code> with
  <code>family=binomial()</code>) has the logit function as its link, so from such
  models <code>match_on</code> computes distances in terms of logits of the
  estimated conditional probabilities, i.e. the estimated log odds.</p>
<p>Optionally these distances are also rescaled. The default is to rescale, by
  the reciprocal of an outlier-resistant variant of the pooled s.d. of
  propensity scores; see <code><a href="standardization_scale.html">standardization_scale</a></code>.  (The
  <code>standardization.scale</code> argument of this function can be used to
  change how this dispersion is calculated, e.g. to calculate an ordinary not
  an outlier-resistant s.d.; it will be passed down
  to <code>standardization_scale</code> as its <code>standardizer</code> argument.)
  To skip rescaling, set argument <code>standardization.scale</code> to 1.
  The overall result records
  absolute differences between treated and control units on linear, possibly
  rescaled, propensity scores.</p>
<p>In addition, one can impose a caliper in terms of these distances by
  providing a scalar as a <code>caliper</code> argument, forbidding matches between
  treatment and control units differing in the calculated propensity score by
  more than the specified caliper.  For example, Rosenbaum and Rubin's (1985)
  caliper of one-fifth of a pooled propensity score s.d. would be imposed by
  specifying <code>caliper=.2</code>, in tandem either with the default rescaling
  or, to follow their example even more closely, with the additional
  specification <code>standardization.scale=sd</code>. Propensity calipers are
  beneficial computationally as well as statistically, for reasons indicated
  in the below discussion of the <code>numeric</code> method.</p>
<p>One can also specify exactMatching criteria by using <code>strata(foo)</code> inside
  the formula to build the <code>glm</code>. For example, passing
  <code>glm(y ~ x + strata(s))</code> to <code>match_on</code> is equivalent to passing
  <code>within=exactMatch(y ~ strata(s))</code>. Note that when combining with
  the <code>caliper</code> argument, the standard deviation used for the caliper will be
  computed across all strata, not within each strata.</p>
<p>If data used to fit the glm have missing values in the left-hand side
  (dependent) variable, these observations are omitted from the output of
  match_on.  If there are observations with missing values in right hand
  side (independent) variables, then a re-fit of the model after imputing
  these variables using a simple scheme and adding indicator variables of
  missingness will be attempted, via the <code><a href="scores.html">scores</a></code> function.</p>
<p><b>First argument (<code>x</code>): <code>bigglm</code>.</b> This method works
  analogously to the <code>glm</code> method, but with <code>bigglm</code> objects,
  created by the <code>bigglm</code> function from package ‘biglm’, which
  can handle bigger data sets than the ordinary glm function can.</p>
<p><b>First argument (<code>x</code>): <code>formula</code>.</b> The formula must have
  <code>Z</code>, the treatment indicator (<code>Z=0</code> indicates control group,
  <code>Z=1</code> indicates treatment group), on the left hand side, and any
  variables to compute a distance on on the right hand side. E.g. <code>Z ~ X1
  + X2</code>. The Mahalanobis distance is calculated as the square root of d'Cd,
  where d is the vector of X-differences on a pair of observations and C is an
  inverse (generalized inverse) of the pooled covariance of Xes. (The pooling
  is of the covariance of X within the subset defined by <code>Z==0</code> and
  within the complement of that subset. This is similar to a Euclidean
  distance calculated after reexpressing the Xes in standard units, such that
  the reexpressed variables all have pooled SDs of 1; except that it addresses
  redundancies among the variables by scaling down variables contributions in
  proportion to their correlations with other included variables.)</p>
<p>Euclidean distance is also available, via <code>method="euclidean"</code>, and
  ranked, Mahalanobis distance, via <code>method="rank_mahalanobis"</code>.</p>
<p>The treatment indicator <code>Z</code> as noted above must either be numeric
  (1 representing treated units and 0 control units) or logical
  (<code>TRUE</code> for treated, <code>FALSE</code> for controls). (Earlier versions of
  the software accepted factor variables and other types of numeric variable; you
  may have to update existing scripts to get them to run.)</p>

<p>As an alternative to specifying a <code>within</code> argument, when <code>x</code> is
  a formula, the <code>strata</code> command can be used inside the formula to specify
  exact matching. For example, rather than using <code>within=exactMatch(y ~
  z, data=data)</code>, you may update your formula as <code>y ~ x + strata(z)</code>. Do
  not use both methods (<code>within</code> and <code>strata</code> simultaneously. Note
  that when combining with the <code>caliper</code> argument, the standard
  deviation used for the caliper will be computed across all strata, not
  separately by stratum.</p>
<p>A unit with NA treatment status (<code>Z</code>) is ignored and will not be included in the distance output.
 Missing values in variables on the right hand side of the formula are handled as follows. By default
<code>match_on</code> will (1) create a matrix of distances between observations which
have only valid values for **all** covariates and then (2) append matrices of Inf values
for distances between observations either of which has a missing values on any of the right-hand-side variables.
(I.e., observations with missing values are retained in the output, but
matches involving them are forbidden.)</p>
<p><b>First argument (<code>x</code>): <code>function</code>.</b> The passed function
  must take arguments: <code>index</code>, <code>data</code>, and <code>z</code>. The
  <code>data</code> and <code>z</code> arguments will be the same as those passed directly
  to <code>match_on</code>. The <code>index</code> argument is a matrix of two columns,
  representing the pairs of treated and control units that are valid
  comparisons (given any <code>within</code> arguments). The first column is the row
  name or id of the treated unit in the <code>data</code> object. The second column
  is the id for the control unit, again in the <code>data</code> object. For each of
  these pairs, the function should return the distance between the treated
  unit and control unit.  This may sound complicated, but is simple to
  use. For example, a function that returned the absolute difference between
  two units using a vector of data would be <code> f &lt;- function(index, data,
  z) { abs(data[index[,1]] - data[index[,2]]) } </code>.  (Note: This simple case is
  precisely handled by the <code>numeric</code> method.)</p>
<p><b>First argument (<code>x</code>): <code>numeric</code>.</b> This returns
  absolute differences between treated and control units' values of <code>x</code>.
  If a caliper is specified, pairings with <code>x</code>-differences greater than
  it are forbidden.  Conceptually, those distances are set to <code>Inf</code>;
  computationally, if either of <code>caliper</code> and <code>within</code> has been
  specified then only information about permissible pairings will be stored,
  so the forbidden pairings are simply omitted. Providing a <code>caliper</code>
  argument here, as opposed to omitting it and afterward applying the
  <code><a href="caliper-methods.html">caliper</a></code> function, reduces storage requirements and may
  otherwise improve performance, particularly in larger problems.</p>
<p>For the numeric method, <code>x</code> must have names. If <code>z</code> is named
  it must have the same names as <code>x</code>, though it allows for a different
  ordering of names. <code>x</code>'s name ordering is considered canonical.</p>
<p><b>First argument (<code>x</code>): <code>matrix</code> or <code>InfinitySparseMatrix</code>.</b> These just return their
  arguments as these objects are already valid distance specifications.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>P.~R. Rosenbaum and D.~B. Rubin (1985), ‘Constructing a
  control group using multivariate matched sampling methods that incorporate
  the propensity score’, <em>The American Statistician</em>, <b>39</b> 33–38.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="fullmatch.html">fullmatch</a></code>, <code><a href="pairmatch.html">pairmatch</a></code>,
  <code><a href="exactMatch.html">exactMatch</a></code>, <code><a href="caliper-methods.html">caliper</a></code></p>
<p><code><a href="scores.html">scores</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">match_on.examples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### Propensity score distances.</span></span></span>
<span class="r-in"><span><span class="co">### Recommended approach:</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">aGlm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span><span class="op">~</span><span class="va">.</span><span class="op">-</span><span class="op">(</span><span class="va">pr</span><span class="op">+</span><span class="va">cost</span><span class="op">)</span>, family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:  glm(formula = pr ~ . - (pr + cost), family = binomial(), data = nuclearplants)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Coefficients:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (Intercept)         date           t1           t2          cap           ne  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   43.909419    -1.220088     0.938645     0.396002     0.001197    -0.995651  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          ct           bw        cum.n           pt  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   -2.615671    -0.088696     0.033575    -0.352112  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Degrees of Freedom: 31 Total (i.e. Null);  22 Residual</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Null Deviance:	    39.75 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Residual Deviance: 20.92 	AIC: 40.92</span>
<span class="r-in"><span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps1</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">aGlm</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### A second approach: first extract propensity scores, then separately</span></span></span>
<span class="r-in"><span><span class="co">### create a distance from them.  (Useful when importing propensity</span></span></span>
<span class="r-in"><span><span class="co">### scores from an external program.)</span></span></span>
<span class="r-in"><span><span class="va">plantsPS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">aGlm</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps2</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">pr</span><span class="op">~</span><span class="va">plantsPS</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### Full matching on the propensity score.</span></span></span>
<span class="r-in"><span><span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="fullmatch.html">fullmatch</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps1</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="fullmatch.html">fullmatch</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps2</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### Because match_on.glm uses robust estimates of spread,</span></span></span>
<span class="r-in"><span><span class="co">### the results differ in detail -- but they are close enough</span></span></span>
<span class="r-in"><span><span class="co">### to yield similar optimal matches.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">fm1</span> <span class="op">==</span> <span class="va">fm2</span><span class="op">)</span> <span class="co"># The same</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Mahalanobis distance:</span></span></span>
<span class="r-in"><span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">mh1</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Absolute differences on a scalar:</span></span></span>
<span class="r-in"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">nuclearplants</span><span class="op">$</span><span class="va">t1</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">absdist</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">tmp</span>, z <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">$</span><span class="va">pr</span>,</span></span>
<span class="r-in"><span>                  within <span class="op">=</span> <span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, <span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`0`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        control</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> treated H  I  J K  L M  N  O P Q R S  T U V  W X Y  Z</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       A 4  0  1 3  2 4  2  2 3 5 7 3  1 8 5  1 6 9 10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       B 3  1  0 2  1 3  1  1 2 4 6 2  0 7 4  0 5 8  9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       C 1  5  4 2  3 1  3  3 2 0 2 2  4 3 0  4 1 4  5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       D 1  5  4 2  3 1  3  3 2 0 2 2  4 3 0  4 1 4  5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       E 2  6  5 3  4 2  4  4 3 1 1 3  5 2 1  5 0 3  4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       F 8 12 11 9 10 8 10 10 9 7 5 9 11 4 7 11 6 3  2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       G 5  9  8 6  7 5  7  7 6 4 2 6  8 1 4  8 3 0  1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $`1`</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        control</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> treated d e f</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       a 1 3 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       b 0 4 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       c 6 2 5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Pair matching on the variable `t1`:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pairmatch.html">pairmatch</a></span><span class="op">(</span><span class="va">absdist</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  0.1  0.1 &lt;NA&gt;  0.2 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;  0.3 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;  0.4 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  0.4  0.3  0.5  0.2  0.6  0.5  0.7  0.7  0.6  1.2  1.3  1.1  1.1  1.2  1.3 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Propensity score matching within subgroups:</span></span></span>
<span class="r-in"><span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps3</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">aGlm</span>, <span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, <span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="fullmatch.html">fullmatch</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps3</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   H   I   A   J   B   K   L   M   C   N   O   P   Q   R   S   T   U   D   V   E </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.3 0.5 0.1 0.3 0.2 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.5 0.3 0.2 0.1 0.1 0.5 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   W   F   X   G   Y   Z   d   e   f   a   b   c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.3 0.1 0.3 0.2 0.3 0.3 1.1 1.3 1.2 1.1 1.2 1.3 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Propensity score matching with a propensity score caliper:</span></span></span>
<span class="r-in"><span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">pscal</span> <span class="op">&lt;-</span> <span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps1</span> <span class="op">+</span> <span class="fu"><a href="caliper-methods.html">caliper</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps1</span>, <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="fullmatch.html">fullmatch</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">pscal</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span> <span class="co"># Note that the caliper excludes some units</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  1.4 &lt;NA&gt;  1.2  1.1 &lt;NA&gt; &lt;NA&gt;  1.2  1.2  1.2  1.2 &lt;NA&gt;  1.2  1.2  1.4  1.2 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.1  1.3  1.3  1.4  1.2  1.3  1.2  1.1 &lt;NA&gt;  1.2  1.4 &lt;NA&gt;  1.2  1.3  1.3  1.1 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### A Mahalanobis distance for matching within subgroups:</span></span></span>
<span class="r-in"><span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">mh2</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> , data <span class="op">=</span> <span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                            within <span class="op">=</span> <span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, <span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Mahalanobis matching within subgroups, with a propensity score</span></span></span>
<span class="r-in"><span><span class="co">### caliper:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="fullmatch.html">fullmatch</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">mh2</span> <span class="op">+</span> <span class="fu"><a href="caliper-methods.html">caliper</a></span><span class="op">(</span><span class="va">match_on.examples</span><span class="op">$</span><span class="va">ps3</span>, <span class="fl">1</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  0.1 &lt;NA&gt;  0.2  0.1 &lt;NA&gt; &lt;NA&gt;  0.2  0.2  0.2  0.2 &lt;NA&gt;  0.2  0.2  0.4  0.2 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.5  0.3  0.3  0.4  0.2  0.5  0.2  0.5 &lt;NA&gt;  0.4  1.1 &lt;NA&gt; &lt;NA&gt;  1.1 &lt;NA&gt;  1.1 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Alternative methods to matching without groups (exact matching)</span></span></span>
<span class="r-in"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data<span class="op">=</span><span class="va">nuclearplants</span>, within<span class="op">=</span><span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, <span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="fu"><a href="strata.html">strata</a></span><span class="op">(</span><span class="va">pt</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># m1 and m2 are identical</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="va">cost</span>, data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                   family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>               data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>               within<span class="op">=</span><span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="va">cost</span> <span class="op">+</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                   family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>               data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>               within<span class="op">=</span><span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu">match_on</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="va">cost</span> <span class="op">+</span> <span class="fu"><a href="strata.html">strata</a></span><span class="op">(</span><span class="va">pt</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                   family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Including `strata(foo)` inside a glm uses `foo` in the model as</span></span></span>
<span class="r-in"><span><span class="co"># well, so here m4 and m5 are equivalent. m3 differs in that it does</span></span></span>
<span class="r-in"><span><span class="co"># not include `pt` in the glm.</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

