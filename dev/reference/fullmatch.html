<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Optimal full matching — fullmatch • optmatch</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Optimal full matching — fullmatch"><meta name="description" content="Given two groups, such as a treatment and a control group, and a method of
creating a treatment-by-control discrepancy matrix indicating desirability and
permissibility of potential matches (or optionally an already created such
discrepancy matrix), create optimal full matches of members of the groups.
Optionally, incorporate restrictions on matched sets' ratios of treatment to
control units."><meta property="og:description" content="Given two groups, such as a treatment and a control group, and a method of
creating a treatment-by-control discrepancy matrix indicating desirability and
permissibility of potential matches (or optionally an already created such
discrepancy matrix), create optimal full matches of members of the groups.
Optionally, incorporate restrictions on matched sets' ratios of treatment to
control units."><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">optmatch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.10.7.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/fullmatch-vignette.html">Matching in R using the optmatch package</a></li>
    <li><a class="dropdown-item" href="../articles/matching-from-foreign-software.html">Using Optmatch on data in SAS, Stata, etc</a></li>
    <li><a class="dropdown-item" href="../articles/matching-within-subgroups.html">Combining Matches Within Subgroups</a></li>
    <li><a class="dropdown-item" href="../articles/MCFSolutions.html">Classes and methods for min-cost flow solutions</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/markmfredrickson/optmatch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Optimal full matching</h1>
      <small class="dont-index">Source: <a href="https://github.com/markmfredrickson/optmatch/blob/master/R/fullmatch.R" class="external-link"><code>R/fullmatch.R</code></a></small>
      <div class="d-none name"><code>fullmatch.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Given two groups, such as a treatment and a control group, and a method of
creating a treatment-by-control discrepancy matrix indicating desirability and
permissibility of potential matches (or optionally an already created such
discrepancy matrix), create optimal full matches of members of the groups.
Optionally, incorporate restrictions on matched sets' ratios of treatment to
control units.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fullmatch</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  min.controls <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  max.controls <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  omit.fraction <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  mean.controls <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  tol <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  solver <span class="op">=</span> <span class="st">""</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">full</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  min.controls <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  max.controls <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  omit.fraction <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  mean.controls <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  tol <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  solver <span class="op">=</span> <span class="st">""</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>Any valid input to <code>match_on</code>. <code>fullmatch</code> will use
<code>x</code> and any optional arguments to generate a distance before performing
the matching.</p>
<p>If <code>x</code> is a numeric vector, there must also be passed a vector <code>z</code>
indicating grouping. Both vectors must be named.</p>
<p>Alternatively, a precomputed distance may be entered. A matrix of
non-negative discrepancies, each indicating the permissibility and
desirability of matching the unit corresponding to its row (a 'treatment') to
the unit corresponding to its column (a 'control'); or, better, a distance
specification as produced by <code><a href="match_on-methods.html">match_on</a></code>.</p></dd>


<dt id="arg-min-controls">min.controls<a class="anchor" aria-label="anchor" href="#arg-min-controls"></a></dt>
<dd><p>The minimum ratio of controls to treatments that is to
be permitted within a matched set: should be non-negative and finite.  If
<code>min.controls</code> is not a whole number, the reciprocal of a whole number,
or zero, then it is rounded <em>down</em> to the nearest whole number or
reciprocal of a whole number.</p>
<p>When matching within subclasses (such as those created by
<code><a href="exactMatch.html">exactMatch</a></code>), <code>min.controls</code> may be a named numeric vector
separately specifying the minimum permissible ratio of controls to treatments
for each subclass.  The names of this vector should include names of all
subproblems <code>distance</code>.</p></dd>


<dt id="arg-max-controls">max.controls<a class="anchor" aria-label="anchor" href="#arg-max-controls"></a></dt>
<dd><p>The maximum ratio of controls to treatments that is
to be permitted within a matched set: should be positive and numeric.
If <code>max.controls</code> is not a whole number, the reciprocal of a
whole number, or <code>Inf</code>, then it is rounded <em>up</em> to the
nearest whole number or reciprocal of a whole number.</p>
<p>When matching within subclasses (such as those created by
<code><a href="exactMatch.html">exactMatch</a></code>), <code>max.controls</code> may be a named numeric vector
separately specifying the maximum permissible ratio of controls to treatments
in each subclass.</p></dd>


<dt id="arg-omit-fraction">omit.fraction<a class="anchor" aria-label="anchor" href="#arg-omit-fraction"></a></dt>
<dd><p>Optionally, specify what fraction of controls or treated
subjects are to be rejected.  If <code>omit.fraction</code> is a positive fraction
less than one, then <code>fullmatch</code> leaves up to that fraction of the control
reservoir unmatched.  If <code>omit.fraction</code> is a negative number greater
than -1, then <code>fullmatch</code> leaves up to |<code>omit.fraction</code>| of the
treated group unmatched.  Positive values are only accepted if
<code>max.controls</code> &gt;= 1; negative values, only if <code>min.controls</code> &lt;= 1.
If neither <code>omit.fraction</code> or <code>mean.controls</code> are specified, then
only those treated and control subjects without permissible matches among the
control and treated subjects, respectively, are omitted.</p>
<p>When matching within subclasses (such as those created by
<code><a href="exactMatch.html">exactMatch</a></code>), <code>omit.fraction</code> specifies the fraction of
controls to be rejected in each subproblem, a parameter that can be made to
differ by subclass by setting <code>omit.fraction</code> equal to a named numeric
vector of fractions.</p>
<p>At most one of <code>mean.controls</code> and <code>omit.fraction</code> can be non-<code>NULL</code>.</p></dd>


<dt id="arg-mean-controls">mean.controls<a class="anchor" aria-label="anchor" href="#arg-mean-controls"></a></dt>
<dd><p>Optionally, specify the average number of controls per
treatment to be matched. Must be no less than than <code>min.controls</code> and no
greater than the either <code>max.controls</code> or the ratio of total number of
controls versus total number of treated. Some controls will likely not be
matched to ensure meeting this value. If neither <code>omit.fraction</code> or
<code>mean.controls</code> are specified, then only those treated and control
subjects without permissible matches among the control and treated subjects,
respectively, are omitted.</p>
<p>When matching within subclasses (such as those created by
<code><a href="exactMatch.html">exactMatch</a></code>), <code>mean.controls</code> specifies the average number of
controls per treatment per subproblem, a parameter that can be made to
differ by subclass by setting <code>mean.controls</code> equal to a named numeric
vector.</p>
<p>At most one of <code>mean.controls</code> and <code>omit.fraction</code> can be non-<code>NULL</code>.</p></dd>


<dt id="arg-tol">tol<a class="anchor" aria-label="anchor" href="#arg-tol"></a></dt>
<dd><p>Because of internal rounding, <code>fullmatch</code> may
solve a slightly different matching problem than the one
specified, in which the match generated by
<code>fullmatch</code> may not coincide with an optimal solution of
the specified problem.  <code>tol</code> times the number of subjects
to be matched specifies the extent to
which <code>fullmatch</code>'s output is permitted to differ from an
optimal solution to the original problem, as measured by the
sum of discrepancies for all treatments and controls placed
into the same matched sets.</p></dd>


<dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>Optional <code>data.frame</code> or <code>vector</code> to use to get order
of the final matching factor. If a <code>data.frame</code>, the <code>rownames</code>
are used. If a vector, the <code>names</code> are first tried, otherwise the contents
is considered to be a character vector of names. Useful to pass if you want to
combine a match (using, e.g., <code>cbind</code>) with the data that were used to
generate it (for example, in a propensity score matching).</p></dd>


<dt id="arg-solver">solver<a class="anchor" aria-label="anchor" href="#arg-solver"></a></dt>
<dd><p>Choose which solver to use. Currently implemented are RELAX-IV
  and LEMON. Default of <code>""</code>, a blank string, will use RELAX-IV if the
  <strong>rrelaxiv</strong> package is installed, otherwise will use LEMON.</p>
<p>To explicitly use RELAX-IV, pass string "RELAX-IV".</p>
<p>To use LEMON, pass string "LEMON". Optionally, to specify which algorithm
LEMON will use, pass the function <a href="LEMON.html">LEMON</a> with argument for the
algorithm name, "CycleCancelling", "CapacityScaling", "CostScaling", and
"NetworkSimplex". See this site for details on their differences:
<a href="https://lemon.cs.elte.hu/pub/doc/latest/a00606.html" class="external-link">https://lemon.cs.elte.hu/pub/doc/latest/a00606.html</a>. CycleCancelling is
the default.</p>
<p>The CycleCancelling algorithm seems to produce results most closely
resembling those of optmatch versions prior to 1.0. We have observed the
other LEMON algorithms to produce different results when the
<code>mean.controls</code> is unspecified, or specified in such a way as to produce
an infeasible matching problem. When using a LEMON algorithm other than
CycleCancelling, we recommend setting the <code>fullmatch_try_recovery</code>
option to <code>FALSE</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments, passed to <code>match_on</code> (e.g. <code>within</code>)
or to specific methods.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code><a href="optmatch.html">optmatch</a></code> object (<code>factor</code>) indicating matched groups.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>If passing an already created discrepancy matrix, finite entries indicate
permissible matches, with smaller discrepancies indicating more desirable
matches.  The matrix must have row and column names.</p>
<p>If it is desirable to create the discrepancies matrix beforehand (for example,
if planning on running several different matching schemes), consider using
<code><a href="match_on-methods.html">match_on</a></code> to generate the distances. This generic function has
several useful methods for handling propensity score models, computing
Mahalanobis distances (and other arbitrary distances), and using user supplied
functions. These distances can also be combined with those generated by
<code><a href="exactMatch.html">exactMatch</a></code> and <code><a href="caliper-methods.html">caliper</a></code> to create very nuanced
matching specifications.</p>
<p>The value of <code>tol</code> can have a substantial effect on computation time;
with smaller values, computation takes longer.  Not every tolerance can be
met, and how small a tolerance is too small varies with the machine and with
the details of the problem.  If <code>fullmatch</code> can't guarantee that the
tolerance is as small as the given value of argument <code>tol</code>, then
matching proceeds but a warning is issued.</p>
<p>By default, <code>fullmatch</code> will attempt, if the given constraints are
infeasible, to find a feasible problem using the same constraints.  This
will almost surely involve using a more restrictive <code>omit.fraction</code> or
<code>mean.controls</code>. (This will never automatically omit treatment units.)
Note that this does not guarantee that the returned match has the least
possible number of omitted subjects, it only gives a match that is feasible
within the given constraints. It may often be possible to loosen the
<code>omit.fraction</code> or <code>mean.controls</code> constraint and still find a
feasible match. The auto recovery is controlled by
<code>options("fullmatch_try_recovery")</code>.</p>
<p>In full matching problems permitting many-one matches (<code>min.controls</code>
less than 1), the number of controls contributing to matches can exceed
what was requested by setting a value of <code>mean.controls</code> or
<code>omit.fraction</code>.  I.e., in this setting <code>mean.controls</code> sets
the minimum ratio of number of controls to number of treatments placed
into matched sets.</p>
<p>If the program detects that (what it thinks is) a large problem,
a warning is issued. Unless you have an older computer, there's a good
chance that you can handle larger problems (at the cost of increased
computation time). To check the large problem threshold, use
<code><a href="getMaxProblemSize.html">getMaxProblemSize</a></code>; to re-set it, use
<code><a href="setMaxProblemSize.html">setMaxProblemSize</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Hansen, B.B. and Klopfer, S.O. (2006), ‘ Optimal full matching and related designs via network flows’,
 <em>Journal of Computational and Graphical Statistics</em>, <b>15</b>, 609–627.</p>
<p>Hansen, B.B. (2004), ‘Full Matching in an Observational Study
 of Coaching for the SAT’, <em>Journal of the American
 Statistical Association</em>, <b>99</b>, 609–618.</p>
<p>Rosenbaum, P. (1991), ‘A Characterization of Optimal Designs for Observational
 Studies’, <em>Journal of the Royal Statistical Society, Series B</em>,
 <b>53</b>, 597–610.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### Full matching on a Mahalanobis distance.</span></span></span>
<span class="r-in"><span><span class="op">(</span> <span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span> <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.3  1.1  1.1  1.8  1.2  1.3  1.3  1.3  1.3  1.8  1.8  1.3  1.5  1.3  1.9 1.10 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.7  1.4  1.4  1.5  1.2  1.6  1.5  1.7  1.3  1.6  1.3  1.3  1.3  1.8  1.9 1.10 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Structure of matched sets:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1:1  1:2  1:3 1:5+ </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    7    1    1    1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Effective Sample Size:  11.7 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (equivalent number of matched pairs).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Full matching with restrictions.</span></span></span>
<span class="r-in"><span><span class="op">(</span> <span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, min.controls <span class="op">=</span> <span class="fl">.5</span>, max.controls <span class="op">=</span> <span class="fl">4</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span> <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.3  1.1  1.1  1.8  1.2  1.3  1.3  1.5  1.3  1.8  1.8  1.3  1.5  1.5  1.9  1.8 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.7  1.4  1.4  1.5  1.2  1.6  1.5  1.7  1.7  1.6  1.9 1.10  1.9  1.8  1.9 1.10 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Structure of matched sets:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:1 1:2 1:3 1:4 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   5   1   1   3 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Effective Sample Size:  12.6 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (equivalent number of matched pairs).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Full matching to half of available controls.</span></span></span>
<span class="r-in"><span><span class="op">(</span> <span class="va">fm3</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, omit.fraction <span class="op">=</span> <span class="fl">.5</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span> <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  1.1  1.1 1.10  1.2 &lt;NA&gt; &lt;NA&gt;  1.3  1.3  1.8 &lt;NA&gt; &lt;NA&gt;  1.5 &lt;NA&gt;  1.9 &lt;NA&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.7  1.4  1.4  1.5  1.2  1.6  1.5  1.7 &lt;NA&gt;  1.6 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;  1.8  1.9 1.10 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Structure of matched sets:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:1 1:2 0:1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   9   1  11 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Effective Sample Size:  10.3 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (equivalent number of matched pairs).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Full matching attempts recovery when the initial restrictions are infeasible.</span></span></span>
<span class="r-in"><span><span class="co">### Limiting max.controls = 1 allows use of only 10 of 22 controls.</span></span></span>
<span class="r-in"><span><span class="op">(</span> <span class="va">fm4</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, max.controls <span class="op">=</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span> <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  1.1  1.1 1.10  1.2 &lt;NA&gt; &lt;NA&gt;  1.3  1.3  1.8 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;  1.9 &lt;NA&gt; </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.7  1.4  1.4  1.5  1.2  1.6  1.5  1.7 &lt;NA&gt;  1.6 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;  1.8  1.9 1.10 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm4</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Structure of matched sets:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:1 0:1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  10  12 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Effective Sample Size:  10 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (equivalent number of matched pairs).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span><span class="co">### To recover restrictions</span></span></span>
<span class="r-in"><span><span class="fu"><a href="optmatch_restrictions.html">optmatch_restrictions</a></span><span class="op">(</span><span class="va">fm4</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $min.controls</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $max.controls</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $omit.fraction</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.5454545</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Full matching within a propensity score caliper.</span></span></span>
<span class="r-in"><span><span class="va">ppty</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="op">(</span><span class="va">pr</span> <span class="op">+</span> <span class="va">cost</span><span class="op">)</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### Note that units without counterparts within the caliper are automatically dropped.</span></span></span>
<span class="r-in"><span><span class="co">### For more complicated models, create a distance matrix and pass it to fullmatch.</span></span></span>
<span class="r-in"><span><span class="va">mhd</span> <span class="op">&lt;-</span> <span class="fu"><a href="match_on-methods.html">match_on</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="caliper-methods.html">caliper</a></span><span class="op">(</span><span class="fu"><a href="match_on-methods.html">match_on</a></span><span class="op">(</span><span class="va">ppty</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">(</span> <span class="va">fm5</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">mhd</span>, data <span class="op">=</span> <span class="va">nuclearplants</span><span class="op">)</span> <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    H    I    A    J    B    K    L    M    C    N    O    P    Q    R    S    T </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;NA&gt;  1.9 &lt;NA&gt;  1.2  1.1 &lt;NA&gt; &lt;NA&gt;  1.2  1.2  1.2  1.2 &lt;NA&gt;  1.2  1.2  1.4  1.1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    U    D    V    E    W    F    X    G    Y    Z    d    e    f    a    b    c </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.5  1.3  1.3  1.4  1.2  1.5  1.2  1.5 &lt;NA&gt;  1.4  1.7 &lt;NA&gt;  1.2  1.7  1.3  1.9 </span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm5</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Structure of matched sets:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1:0  2:1  1:1  1:2 1:5+  0:1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    1    2    3    1    1    6 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Effective Sample Size:  8.8 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (equivalent number of matched pairs).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Propensity balance assessment. Requires RItools package.</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=RItools" class="external-link">RItools</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fm5</span>,<span class="va">ppty</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: RItools</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: ggplot2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Structure of matched sets:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1:0  2:1  1:1  1:2 1:5+  0:1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    1    2    3    1    1    6 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Effective Sample Size:  8.8 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (equivalent number of matched pairs).</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Balance test overall result:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   chisquare df p.value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        7.93  9   0.542</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### The order of the names in the match factor is the same</span></span></span>
<span class="r-in"><span><span class="co">### as the nuclearplants data.frame since we used the data argument</span></span></span>
<span class="r-in"><span><span class="co">### when calling fullmatch. The order would be unspecified otherwise.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">nuclearplants</span>, matches <span class="op">=</span> <span class="va">fm5</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cost  date t1 t2  cap pr ne ct bw cum.n pt matches</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> H 460.05 68.58 14 46  687  0  1  0  0    14  0    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> I 452.99 67.33 10 73 1065  0  0  1  0     1  0     1.9</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> A 443.22 67.33 10 85 1065  1  0  1  0     1  0    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> J 652.32 68.00 11 67 1065  0  1  1  0    12  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> B 642.23 68.00 11 78 1065  1  1  1  0    12  0     1.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> K 345.39 67.92 13 51  514  0  1  1  0     3  0    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> L 272.37 68.17 12 50  822  0  0  0  0     5  0    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> M 317.21 68.42 14 59  457  0  0  0  0     1  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> C 457.12 68.42 15 55  822  1  0  0  0     5  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> N 690.19 68.33 12 71  792  0  1  1  1     2  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> O 350.63 68.58 12 64  560  0  0  0  0     3  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> P 402.59 68.75 13 47  790  0  1  0  0     6  0    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Q 412.18 68.42 15 62  530  0  0  1  0     2  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> R 495.58 68.92 17 52 1050  0  0  0  0     7  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> S 394.36 68.92 13 65  850  0  0  0  1    16  0     1.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> T 423.32 68.42 11 67  778  0  0  0  0     3  0     1.1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> U 712.27 69.50 18 60  845  0  1  0  0    17  0     1.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> D 289.66 68.42 15 76  530  1  0  1  0     2  0     1.3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> V 881.24 69.17 15 67 1090  0  0  0  0     1  0     1.3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> E 490.88 68.92 16 59 1050  1  0  0  0     8  0     1.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> W 567.79 68.75 11 70  913  0  0  1  1    15  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F 665.99 70.92 22 57  828  1  1  0  0    20  0     1.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> X 621.45 69.67 16 59  786  0  0  1  0    18  0     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> G 608.80 70.08 19 58  821  1  0  0  0     3  0     1.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Y 473.64 70.42 19 44  538  0  0  1  0    19  0    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Z 697.14 71.08 20 57 1130  0  0  1  0    21  0     1.4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> d 207.51 67.25 13 63  745  0  0  0  0     8  1     1.7</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> e 288.48 67.17  9 48  821  0  0  1  0     7  1    &lt;NA&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> f 284.88 67.83 12 63  886  0  0  0  1    11  1     1.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> a 280.36 67.83 12 71  886  1  0  0  1    11  1     1.7</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> b 217.38 67.25 13 72  745  1  0  0  0     8  1     1.3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> c 270.71 67.83  7 80  886  1  0  0  1    11  1     1.9</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Match in subgroups only. There are a few ways to specify this.</span></span></span>
<span class="r-in"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                within<span class="op">=</span><span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="fu"><a href="strata.html">strata</a></span><span class="op">(</span><span class="va">pt</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">### Matching on propensity scores within matching in subgroups only:</span></span></span>
<span class="r-in"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span>, data<span class="op">=</span><span class="va">nuclearplants</span>, family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                within<span class="op">=</span><span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                    family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                within<span class="op">=</span><span class="fu"><a href="exactMatch.html">exactMatch</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">pt</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu">fullmatch</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">pr</span> <span class="op">~</span> <span class="va">t1</span> <span class="op">+</span> <span class="va">t2</span> <span class="op">+</span> <span class="fu"><a href="strata.html">strata</a></span><span class="op">(</span><span class="va">pt</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span>,</span></span>
<span class="r-in"><span>                    family<span class="op">=</span><span class="va">binomial</span><span class="op">)</span>, data<span class="op">=</span><span class="va">nuclearplants</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Including `strata(foo)` inside a glm uses `foo` in the model as</span></span></span>
<span class="r-in"><span><span class="co"># well, so here m4 and m5 are equivalent. m3 differs in that it does</span></span></span>
<span class="r-in"><span><span class="co"># not include `pt` in the glm.</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

