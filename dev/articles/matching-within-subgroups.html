<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Combining Matches Within Subgroups • optmatch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combining Matches Within Subgroups">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">optmatch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.10.8.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fullmatch-vignette.html">Matching in R using the optmatch package</a></li>
    <li><a class="dropdown-item" href="../articles/matching-from-foreign-software.html">Using Optmatch on data in SAS, Stata, etc</a></li>
    <li><a class="dropdown-item" href="../articles/matching-within-subgroups.html">Combining Matches Within Subgroups</a></li>
    <li><a class="dropdown-item" href="../articles/MCFSolutions.html">Classes and methods for min-cost flow solutions</a></li>
    <li><a class="dropdown-item" href="../articles/performance.html">Performance Testing</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/markmfredrickson/optmatch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Combining Matches Within Subgroups</h1>
                        <h4 data-toc-skip class="author">Ben B. Hansen,
Mark Fredrickson, Josh Errickson, Josh Buckner</h4>
            
            <h4 data-toc-skip class="date">2025-06-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/markmfredrickson/optmatch/blob/master/vignettes/matching-within-subgroups.Rmd" class="external-link"><code>vignettes/matching-within-subgroups.Rmd</code></a></small>
      <div class="d-none name"><code>matching-within-subgroups.Rmd</code></div>
    </div>

    
    
<p>When utilizing full matching, a user may want to introduce
restrictions to the potential match sets. There are two main reasons to
do this.</p>
<ul>
<li>There may be certain variables which matches should either always or
never agree upon. For example, if there is a binary gender variable, you
may wish to only match treatment members to control members of the same
gender.</li>
<li>When matching on a medium-to-large data set, speed concerns can
become paramount. By splitting the matching problem into a series of
smaller subproblems, we can realize substantial performance
improvements.</li>
</ul>
<div class="section level2">
<h2 id="combining-matches">Combining matches<a class="anchor" aria-label="anchor" href="#combining-matches"></a>
</h2>
<p>In optmatch 0.9-11 and above, <code>optmatch</code> objects can be
easily combined to facilitate breaking a problem into smaller
sub-problems and reconstituting a matched structure on the entire data
set. To demonstrate this, let’s consider the <code>infert</code> data
set.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">data</span>(infert)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(infert)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="do">##   education age parity induced case spontaneous stratum pooled.stratum</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="do">## 1    0-5yrs  26      6       1    1           2       1              3</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="do">## 2    0-5yrs  42      1       1    1           0       2              1</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="do">## 3    0-5yrs  39      6       2    1           0       3              4</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="do">## 4    0-5yrs  34      4       2    1           0       4              2</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="do">## 5   6-11yrs  35      3       1    1           1       5             32</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="do">## 6   6-11yrs  36      4       2    1           1       6             36</span></span></code></pre></div>
<p>The “case” variable indicates treatment (1) versus control (0)
status. We’ll want to match upon “age”.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">table</span>(infert<span class="sc">$</span>case)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="do">##   0   1 </span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="do">## 165  83</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">table</span>(infert<span class="sc">$</span>education, infert<span class="sc">$</span>case)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="do">##          </span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="do">##            0  1</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="do">##   0-5yrs   8  4</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="do">##   6-11yrs 80 40</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="do">##   12+ yrs 77 39</span></span></code></pre></div>
<p>Due to the sample size, if we were to compute matches on the entire
data set, the <code>fullmatch</code> call would generate a distance
matrix of size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>165</mn><mo>×</mo><mn>83</mn><mo>=</mo><mn>13</mn><mo>,</mo><mn>695</mn></mrow><annotation encoding="application/x-tex">165\times 83 = 13,695</annotation></semantics></math>.
However, if we were instead to compute a match within each level of the
“education” variable, we’d compute three different distance matrices, of
total size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>4</mn><mo>+</mo><mn>80</mn><mo>×</mo><mn>40</mn><mo>+</mo><mn>77</mn><mo>×</mo><mn>39</mn><mo>=</mo><mn>6</mn><mo>,</mo><mn>235</mn></mrow><annotation encoding="application/x-tex">8\times 4 + 80\times 40 + 77\times 39 = 6,235</annotation></semantics></math>,
a reduction of 55%.</p>
<p>We’ll do this by splitting the data within each match.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="sc">&gt;</span> f1 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(case <span class="sc">~</span> age, <span class="at">data =</span> infert[infert<span class="sc">$</span>education <span class="sc">==</span> <span class="st">"0-5yrs"</span>, ])</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="sc">&gt;</span> f2 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(case <span class="sc">~</span> age, <span class="at">data =</span> infert[infert<span class="sc">$</span>education <span class="sc">==</span> <span class="st">"6-11yrs"</span>, ])</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="sc">&gt;</span> f3 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(case <span class="sc">~</span> age, <span class="at">data =</span> infert[infert<span class="sc">$</span>education <span class="sc">==</span> <span class="st">"12+ yrs"</span>, ])</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(f1)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="do">## 1:2 </span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="do">##   4 </span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="do">## Effective Sample Size:  5.3 </span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(f2)</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="do">##  1:1  1:2  1:3  1:4 1:5+ </span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="do">##   20    8    6    4    2 </span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="do">## Effective Sample Size:  49.4 </span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(f3)</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="do">##  1:1  1:2  1:3  1:4 1:5+ </span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="do">##   23    5    6    2    3 </span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="do">## Effective Sample Size:  47 </span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span></code></pre></div>
<p>Some of the matched sets are quite large (1:5+) so let’s put some
restrictions.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="sc">&gt;</span> f2 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(case <span class="sc">~</span> age, <span class="at">data =</span> infert[infert<span class="sc">$</span>education <span class="sc">==</span> <span class="st">"6-11yrs"</span>, ],</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="sc">+</span>                 <span class="at">max.controls =</span> <span class="dv">4</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="sc">&gt;</span> f3 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(case <span class="sc">~</span> age, <span class="at">data =</span> infert[infert<span class="sc">$</span>education <span class="sc">==</span> <span class="st">"12+ yrs"</span>, ],</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="sc">+</span>                 <span class="at">max.controls =</span> <span class="dv">4</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(f2)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="do">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="do">##  18  10   6   6 </span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="do">## Effective Sample Size:  49.9 </span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(f3)</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="do">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="do">##  20   6   7   6 </span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="do">## Effective Sample Size:  48.1 </span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span></code></pre></div>
<p>Now we simply combine the three matches.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="sc">&gt;</span> fcombine <span class="ot">&lt;-</span> <span class="fu">c</span>(f1, f2, f3)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(fcombine)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="do">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="do">##  38  20  13  12 </span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="do">## Effective Sample Size:  103.4 </span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="sc">&gt;</span> infert<span class="sc">$</span>match <span class="ot">&lt;-</span> fcombine</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-the-within-argument">Using the <code>within</code> argument<a class="anchor" aria-label="anchor" href="#using-the-within-argument"></a>
</h2>
<p>An alternative approach would be using the <code>within</code>
argument and the <code>exactMatch</code> function to define
subproblems.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="sc">&gt;</span> fwithin <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(case <span class="sc">~</span> age, <span class="at">data =</span> infert, <span class="at">max.controls =</span> <span class="dv">4</span>,</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="sc">+</span>                      <span class="at">within =</span> <span class="fu">exactMatch</span>(case <span class="sc">~</span> education, <span class="at">data =</span> infert))</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(fwithin)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="do">## Structure of matched sets:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="do">## 1:1 1:2 1:3 1:4 </span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="do">##  38  20  13  12 </span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="do">## Effective Sample Size:  103.4 </span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="do">## (equivalent number of matched pairs).</span></span></code></pre></div>
<p>Observe that we obtain equivalent matched structure. A few notes
comparing the two approaches:</p>
<ol style="list-style-type: decimal">
<li>
<p>When using the <code>within</code> argument, restrictions must be
the same across subproblems. That is, <code>max.controls</code>,
<code>min.controls</code> and <code>omit.fraction</code> will be
equivalent. By running the subproblems separately, you can set different
restrictions per subproblem. E.g.,</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="sc">&gt;</span> f1 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(z <span class="sc">~</span> x, <span class="at">data =</span> d[d<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">1</span>, ], <span class="at">max.controls =</span> <span class="dv">2</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="sc">&gt;</span> f2 <span class="ot">&lt;-</span> <span class="fu">fullmatch</span>(z <span class="sc">~</span> x, <span class="at">data =</span> d[d<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">2</span>, ], <span class="at">min.controls =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">c</span>(f1, f2)</span></code></pre></div>
</li>
<li><p>While the matched structures will be equivalent between these two
approaches (if the restrictions are the same across subproblems), the
actual matched sets themselves may differ if you have observations of
equal distance. In general this should not be considered a
problem.</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ben Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
