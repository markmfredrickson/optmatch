<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Distance based bipartite matching using minimum cost flow, oriented
    to matching of treatment and control groups in observational studies (Hansen
    and Klopfer 2006 &lt;doi:10.1198/106186006X137047&gt;). Routines are provided to
    generate distances from generalised linear models (propensity score
    matching), formulas giving variables on which to limit matched distances,
    stratified or exact matching directives, or calipers, alone or in
    combination.">
<title>Functions for Optimal Matching • optmatch</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Functions for Optimal Matching">
<meta property="og:description" content="Distance based bipartite matching using minimum cost flow, oriented
    to matching of treatment and control groups in observational studies (Hansen
    and Klopfer 2006 &lt;doi:10.1198/106186006X137047&gt;). Routines are provided to
    generate distances from generalised linear models (propensity score
    matching), formulas giving variables on which to limit matched distances,
    stratified or exact matching directives, or calipers, alone or in
    combination.">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">optmatch</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.10.2.9001</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/fullmatch-vignette.html">Matching in R using the optmatch and RItools packages</a>
    <a class="dropdown-item" href="articles/matching-from-foreign-software.html">Using Optmatch on data in SAS, Stata, etc</a>
    <a class="dropdown-item" href="articles/matching-within-subgroups.html">Combining Matches Within Subgroups</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/markmfredrickson/optmatch/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="optmatch-optimal-fullmatching-for-r">optmatch: Optimal Fullmatching for R<a class="anchor" aria-label="anchor" href="#optmatch-optimal-fullmatching-for-r"></a>
</h1></div>
<p>Package website: <a href="https://markmfredrickson.github.io/optmatch">release</a> | <a href="https://markmfredrickson.github.io/optmatch/dev">development</a></p>
<!-- badges: start -->
<p>The <strong>optmatch</strong> package implements the optimal full matching algorithm for bipartite matching problems. Given a matrix describing the distances between two groups (where one group is represented by row entries, and the other by column entries), the algorithm finds a matching between units that minimizes the average within grouped distances. This algorithm is a popular choice for covariate balancing applications (e.g. propensity score matching), but it also can be useful for design stage applications such as blocking. For more on the application and its implementation, see:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>Hansen, B.B. and Klopfer, <span class="kw">S.O.</span> (<span class="dv">2006</span>) Optimal full matching and</span>
<span id="cb1-2"><a href="#cb1-2"></a> related designs via network flows, JCGS <span class="dv">15</span> <span class="dv">609</span><span class="fl">-627.</span></span></code></pre></div>
<p><strong>optmatch</strong> is available on <a href="https://cran.r-project.org" class="external-link">CRAN</a>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">install.packages</span>(<span class="st">"optmatch"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">library</span>(<span class="st">"optmatch"</span>)</span></code></pre></div>
<div class="section level2">
<h2 id="choice-of-solvers">Choice of solvers<a class="anchor" aria-label="anchor" href="#choice-of-solvers"></a>
</h2>
<p>There are two different packages implementing the actual solver which can be used.</p>
<ul>
<li>The default, starting in 0.10.0, is the <a href="https://lemon.cs.elte.hu/trac/lemon" class="external-link">LEMON graph library</a>’s Min Cost Flow solver, implemented in the <a href="https://cran.r-project.org/web/packages/rlemon/index.html" class="external-link"><strong>rlemon</strong></a> package.</li>
<li>In previous versions, the default was the RELAX-IV solver, which is now implemented in the <a href="https://github.com/josherrickson/rrelaxiv/" class="external-link"><strong>rrelaxiv</strong></a> package.</li>
</ul>
<p>Users wishing to utilize the RELAX-IV solver must install <strong>rrelaxiv</strong> separately, see that page for details. Once installed, RELAX-IV becomes the default solver.</p>
<p>The LEMON solver has four separate algorithms implemented, Cycle Cancelling (the default), Network Simplex, Cost Scaling, and Capacity Scaling. Each has its own trade-offs and performance quirks. See <code><a href="reference/fullmatch.html">help(fullmatch)</a></code> for details of how to choose which is being used.</p>
</div>
<div class="section level2">
<h2 id="using-optmatch">Using optmatch<a class="anchor" aria-label="anchor" href="#using-optmatch"></a>
</h2>
<p>In addition to the optimal full matching algorithm, the package contains useful functions for generating distance specifications, combining and editing distance specifications, and summarizing and displaying matches. This walk through shows how to use these tools in your matching workflow.</p>
<div class="section level3">
<h3 id="simulated-data">Simulated data<a class="anchor" aria-label="anchor" href="#simulated-data"></a>
</h3>
<p>Before we start, let’s generate some simulated data. We will have two groups, the “treated” and “control” groups. Without our knowledge, nature assigned units from a pool into one of these two groups. The probability of being a treated unit depends on some covariates. In the vector <code>Z</code>, let a 1 denote treated units and 0 denote control units</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">set.seed</span>(<span class="dv">20120111</span>) <span class="co"># set this to get the exact same answers as I do</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>n &lt;-<span class="st"> </span><span class="dv">26</span> <span class="co"># chosen so we can divide the alphabet in half</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>W &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">w1 =</span> <span class="kw">rbeta</span>(n, <span class="dv">4</span>, <span class="dv">2</span>), <span class="dt">w2 =</span> <span class="kw">rbinom</span>(n, <span class="dv">1</span>, <span class="dt">p =</span> <span class="fl">.33</span>))</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># nature assigns to treatment</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>tmp &lt;-<span class="st"> </span><span class="kw">numeric</span>(n)</span>
<span id="cb3-7"><a href="#cb3-7"></a>tmp[<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span>n, <span class="dt">prob =</span> W<span class="op">$</span>w1<span class="op">^</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>W<span class="op">$</span>w2), <span class="dt">size =</span> n<span class="op">/</span><span class="dv">2</span>)] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>W<span class="op">$</span>z &lt;-<span class="st"> </span>tmp</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"># for convenience, let's give the treated units capital letter names</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>tmp &lt;-<span class="st"> </span><span class="kw">character</span>(n)</span>
<span id="cb3-12"><a href="#cb3-12"></a>tmp[W<span class="op">$</span>z <span class="op">==</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span>LETTERS[<span class="dv">1</span><span class="op">:</span>(n<span class="op">/</span><span class="dv">2</span>)]</span>
<span id="cb3-13"><a href="#cb3-13"></a>tmp[W<span class="op">$</span>z <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>letters[(<span class="dv">26</span> <span class="op">-</span><span class="st"> </span>n<span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span><span class="dv">26</span>]</span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="kw">rownames</span>(W) &lt;-<span class="st"> </span>tmp</span></code></pre></div>
<p>As we can see with a simple table and plot, these groups are not balanced on the covariates, as they would be (in expectation) with a randomly assigned treatment.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">table</span>(W<span class="op">$</span>w2, W<span class="op">$</span>z)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">library</span>(lattice) ; <span class="kw">densityplot</span>(W<span class="op">$</span>w1, <span class="dt">groups =</span> W<span class="op">$</span>z)</span></code></pre></div>
<p>The next steps use the covariates to pair up similar treated and control units. For more on assessing the amount and severity of imbalance between groups on observed covariates, see the <a href="https://github.com/markmfredrickson/RItools" class="external-link">RItools</a> <code>R</code> package.</p>
</div>
<div class="section level3">
<h3 id="setting-up-distances">Setting up distances<a class="anchor" aria-label="anchor" href="#setting-up-distances"></a>
</h3>
<p>These two groups are different, but how different are individual treated units from individual control units? In answering this question, we will produce several distance specifications: matrices of treated units (rows) by control units (columns) with entries denoting distances. <strong>optmatch</strong> provides several ways of generating these matrices so that you don’t have to do it by hand.</p>
<p>Let’s begin with a simple Euclidean distance on the space defined by <code>W</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>distances &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb5-2"><a href="#cb5-2"></a>distances<span class="op">$</span>euclid &lt;-<span class="st"> </span><span class="kw">match_on</span>(z <span class="op">~</span><span class="st"> </span>w1 <span class="op">+</span><span class="st"> </span>w2, <span class="dt">data =</span> W, <span class="dt">method =</span> <span class="st">"euclidean"</span>)</span></code></pre></div>
<p>The <code>method</code> argument tells the <code>match_on</code> function how to compute the distances over the space defined by the formula. The default method extends the simple Euclidean distance by rescaling the distances by the covariance of the variables, the <a href="https://en.wikipedia.org/wiki/Mahalanobis_distance" class="external-link">Mahalanobis distance</a>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>distances<span class="op">$</span>mahal &lt;-<span class="st"> </span><span class="kw">match_on</span>(z <span class="op">~</span><span class="st"> </span>w1 <span class="op">+</span><span class="st"> </span>w2, <span class="dt">data =</span> W)</span></code></pre></div>
<p>You can write additional distance computation functions. See the documentation for <code>match_on</code> for more details on how to create these functions.</p>
<p>To create distances, we could also try regressing the treatment indicator on the covariates and computing the difference distance for each treated and control pair. To make this process easier, <code>match_on</code> has methods for <code>glm</code> objects (and for big data problems, <code>bigglm</code> objects):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>propensity.model &lt;-<span class="st"> </span><span class="kw">glm</span>(z <span class="op">~</span><span class="st"> </span>w1 <span class="op">+</span><span class="st"> </span>w2, <span class="dt">data =</span> W, <span class="dt">family =</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="kw">binomial</span>())</span>
<span id="cb7-3"><a href="#cb7-3"></a>distances<span class="op">$</span>propensity &lt;-<span class="st"> </span><span class="kw">match_on</span>(propensity.model)</span></code></pre></div>
<p>The <code>glm</code> method is a wrapper around the <code>numeric</code> method for <code>match_on</code>. The <code>numeric</code> method takes a vector of scores (for example, the linear prediction for each unit from the model) and a vector indicating treatment status (<code>z</code>) for each unit. This method returns the absolute difference between each treated and control pair on their scores (additionally, the <code>glm</code> method rescales the data before invoking the <code>numeric</code> method). If you wish to fit a “caliper” to your distance matrix, a hard limit on allowed distances between treated and control units, you can pass a <code>caliper</code> argument, a scalar numeric value. Any treated and control pair that is larger than the caliper value will be replaced by <code>Inf</code>, an unmatchable value. The <code>caliper</code> argument also applies to <code>glm</code> method. Calipers are covered in more detail in the next section.</p>
<p>The final convenience method of <code>match_on</code> is using an arbitrary function. This function is probably most useful for advanced users of <strong>optmatch</strong>. See the documentation of the <code>match_on</code> function for more details on how to write your own arbitrary computation functions.</p>
</div>
<div class="section level3">
<h3 id="combining-and-editing-distances">Combining and editing distances<a class="anchor" aria-label="anchor" href="#combining-and-editing-distances"></a>
</h3>
<p>We have created several representations of the matching problem, using Euclidean distance, Mahalanobis distance, the estimated propensity score, and an arbitrary function. We can combine these distances into single metric using standard arithmetic functions:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>distances<span class="op">$</span>all &lt;-<span class="st"> </span><span class="kw">with</span>(distances, euclid <span class="op">+</span><span class="st"> </span>mahal <span class="op">+</span><span class="st"> </span>propensity)</span></code></pre></div>
<p>You may find it convenient to work in smaller pieces at first and then stitch the results together into a bigger distance. The <code>rbind</code> and <code>cbind</code> functions let us add additional treated and control entries to a distance specification for each of the existing control and treated units, respectively. For example, we might want to combine a Mahalanobis score for units <code>n</code> through <code>s</code> with a propensity score for units <code>t</code> through <code>z</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>W.n.to.s &lt;-<span class="st"> </span>W[<span class="kw">c</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">13</span>], letters[<span class="dv">14</span><span class="op">:</span><span class="dv">19</span>]),]</span>
<span id="cb9-2"><a href="#cb9-2"></a>W.t.to.z &lt;-<span class="st"> </span>W[<span class="kw">c</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">13</span>], letters[<span class="dv">20</span><span class="op">:</span><span class="dv">26</span>]),]</span>
<span id="cb9-3"><a href="#cb9-3"></a>mahal.n.to.s &lt;-<span class="st"> </span><span class="kw">match_on</span>(z <span class="op">~</span><span class="st"> </span>w1 <span class="op">+</span><span class="st"> </span>w2, <span class="dt">data =</span> W.n.to.s)</span>
<span id="cb9-4"><a href="#cb9-4"></a>ps.t.to.z &lt;-<span class="st"> </span><span class="kw">match_on</span>(<span class="kw">glm</span>(z <span class="op">~</span><span class="st"> </span>w1 <span class="op">+</span><span class="st"> </span>w2, <span class="dt">data =</span> W.t.to.z, <span class="dt">family =</span> <span class="kw">binomial</span>()))</span>
<span id="cb9-5"><a href="#cb9-5"></a>distances<span class="op">$</span>combined &lt;-<span class="st"> </span><span class="kw">cbind</span>(mahal.n.to.s, ps.t.to.z)</span></code></pre></div>
<p>The <code>exactMatch</code> function creates “stratified” matching problems, in which there are subgroups that are completely separate. Such matching problems are often much easier to solve than problems where a treated unit could be connected to any control unit.</p>
<p>There is another method for creating reduced matching problems. The <code>caliper</code> function compares each entry in an existing distance specification and disallows any that are larger than a specified value. For example, we can trim our previous combined distance to anything smaller than the median value:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>distances<span class="op">$</span>median.caliper &lt;-<span class="st"> </span><span class="kw">caliper</span>(distances<span class="op">$</span>all, <span class="kw">median</span>(distances<span class="op">$</span>all))</span>
<span id="cb10-2"><a href="#cb10-2"></a>distances<span class="op">$</span>all.trimmed &lt;-<span class="st"> </span><span class="kw">with</span>(distances, all <span class="op">+</span><span class="st"> </span>median.caliper)</span></code></pre></div>
<p>Like the <code>exactMatch</code> function, the results of <code>caliper</code> used the sparse matrix representation mentioned above, so can be very efficient for large, sparse problems. As noted previously, if using the <code>glm</code> or <code>numeric</code> methods of <code>match_on</code>, passing the caliper’s width in the <code>caliper</code> argument can be more efficient.</p>
</div>
<div class="section level3">
<h3 id="speeding-up-computation">Speeding up computation<a class="anchor" aria-label="anchor" href="#speeding-up-computation"></a>
</h3>
<p>In addition to the space advantages of only storing the finite entries in a sparse matrix, the results of <code>exactMatch</code> and <code>caliper</code> can be used to speed up computation of <em>new</em> distances. The <code>match_on</code> function that we saw earlier has an argument called <code>within</code> that helps filter the resulting computation to only the finite entries in the <code>within</code> matrix. Since <code>exactMatch</code> and <code>caliper</code> use finite entries denote valid pairs, they make excellent sources of the <code>within</code> argument.</p>
<p>Instead of creating the entire Euclidean distance matrix and <em>then</em> filtering out cross-strata matches, we use the results of <code>exactMatch</code> to compute only the interesting cases:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>tmp &lt;-<span class="st"> </span><span class="kw">exactMatch</span>(z <span class="op">~</span><span class="st"> </span>w2, <span class="dt">data =</span> W)</span>
<span id="cb11-2"><a href="#cb11-2"></a>distances<span class="op">$</span>exact &lt;-<span class="st"> </span><span class="kw">match_on</span>(z <span class="op">~</span><span class="st"> </span>w1, <span class="dt">data =</span> W, <span class="dt">within =</span> tmp)</span></code></pre></div>
<p>Users of previous versions of <strong>optmatch</strong> may notice that the <code>within</code> argument is similar to the old <code>structure.formula</code> argument. Like <code>within</code>, <code>structure.formula</code> focused distance on within strata pairs. Unlike <code>structure.formula</code>, the <code>within</code> argument allows using <em>any</em> distance specification as an argument, including those created with <code>caliper</code>. For example, here is the Mahalanobis distance computed only for units that differ by less than one on the propensity score.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>distances<span class="op">$</span>mahal.trimmed &lt;-<span class="st"> </span><span class="kw">match_on</span>(z <span class="op">~</span><span class="st"> </span>w1 <span class="op">+</span><span class="st"> </span>w2, <span class="dt">data =</span> W,</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="dt">within =</span> <span class="kw">match_on</span>(propensity.model, <span class="dt">caliper =</span> <span class="dv">1</span>))</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generating-the-match">Generating the match<a class="anchor" aria-label="anchor" href="#generating-the-match"></a>
</h3>
<p>Now that we have generated several distances specifications, let’s put them to use. Here is the simplest way to evaluate all distances specifications:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>matches &lt;-<span class="st"> </span><span class="kw">lapply</span>(distances, <span class="cf">function</span>(x) { <span class="kw">fullmatch</span>(x, <span class="dt">data =</span> W) })</span></code></pre></div>
<p>The result of the matching process is a named factor, where the names correspond to the units (both treated and control) and the levels of the factors are the matched groups. Including the <code>data</code> argument is highly recommended. This argument will make sure that the result of <code>fullmatch</code> will be in the same order as the original <code>data.frame</code> that was used to build the distance specification. This will make appending the results of <code>fullmatch</code> on to the original <code>data.frame</code> much more convenient.</p>
<p>The <code>fullmatch</code> function as several arguments for fine tuning the allowed ratio of treatment to control units in a match, and how much of the pool to throw away as unmatchable. One common pattern for these arguments are pairs: one treated to one control unit. Not every distance specification is amendable to this pattern (e.g. when there are more treated units than control units in <code>exactMatch</code> created stratum). However, it can be done with the Mahalanobis distance matrix we created earlier:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>mahal.match &lt;-<span class="st"> </span><span class="kw">pairmatch</span>(distances<span class="op">$</span>mahal, <span class="dt">data =</span> W)</span></code></pre></div>
<p>Like <code>fullmatch</code>, <code>pairmatch</code> also allows fine tuning the ratio of matches to allow larger groupings. It is can be helpful as it computes what percentage of the group to throw away, giving better odds of successfully finding a matching solution.</p>
<p>Once one has generated a match, you may wish to view the results. The results of calls to <code>fullmatch</code> or <code>pairmatch</code> produce <strong>optmatch</strong> objects (specialized factors). This object has a special option to the <code>print</code> method which groups the units by factor level:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">print</span>(mahal.match, <span class="dt">grouped =</span> T)</span></code></pre></div>
<p>If you wish to join the match factor back to the original <code>data.frame</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>W.matched &lt;-<span class="st"> </span><span class="kw">cbind</span>(W, <span class="dt">matches =</span> mahal.match)</span></code></pre></div>
<p>Make sure to include the <code>data</code> argument to <code>fullmatch</code> or <code>pairmatch</code>, otherwise results are not guaranteed to be in the same order as your original <code>data.frame</code> or <code>matrix</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-a-development-version-of-optmatch">Using a development version of Optmatch<a class="anchor" aria-label="anchor" href="#using-a-development-version-of-optmatch"></a>
</h2>
<p>This section will help you get the latest development version of <strong>optmatch</strong> and start using the latest features. Before starting, you should know which branch you wish to install. Currently, the “master” branch is the main code base. Additional features are added in their own branches. A list of branches is available at (the <strong>optmatch</strong> project page)[<a href="https://github.com/markmfredrickson/optmatch" class="external-link uri">https://github.com/markmfredrickson/optmatch</a>].</p>
<div class="section level3">
<h3 id="installing-a-development-version">Installing a development version<a class="anchor" aria-label="anchor" href="#installing-a-development-version"></a>
</h3>
<p>You may need additional compilers as distributed by CRAN: <a href="https://cran.r-project.org/bin/macosx/tools/" class="external-link">OS X</a>, <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Windows</a>.</p>
<p>We recommend using <code>dev_mode</code> from the <code>devtools</code> package to install in-development version of the package so that you can keep the current CRAN version as the primary package. Activating <code>dev_mode</code> creates a secondary library of packages which can only be accessed while in <code>dev_mode</code>. Packages normally installed can still be used, but if different versions are installed normally and in <code>dev_mode</code>, the <code>dev_mode</code> version takes precedent if in <code>dev_mode</code>.</p>
<p>Install and load the <code>devtools</code> package:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">install.packages</span>(<span class="st">"devtools"</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">library</span>(<span class="st">"devtools"</span>)</span></code></pre></div>
<p>Activate <code>dev_mode</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">dev_mode</span>()</span>
<span id="cb18-2"><a href="#cb18-2"></a>d<span class="op">&gt;</span></span></code></pre></div>
<p>Note that the prompt changes from <code>&gt;</code> to <code>d&gt;</code> to let you know you’re in <code>dev_mode</code>. Now choose the development branch you want to use. To install <code>master</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>d<span class="op">&gt;</span><span class="st"> </span><span class="kw">install_github</span>(<span class="st">"markmfredrickson/optmatch"</span>)</span></code></pre></div>
<p>Either way, the package is then loaded in the usual fashion, provided you’re still in <code>dev_mode</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a> d<span class="op">&gt;</span><span class="st"> </span><span class="kw">library</span>(optmatch)</span></code></pre></div>
<p>Once you’ve done this you can disable <code>dev_mode</code> as follows</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>d<span class="op">&gt;</span><span class="st"> </span><span class="kw">dev_mode</span>()</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="op">&gt;</span></span></code></pre></div>
<p>The development version of the package remains loaded.</p>
<p>Note that if you load the package – ie, enter <code><a href="https://github.com/markmfredrickson/optmatch" class="external-link">library(optmatch)</a></code> (when the package hasn’t already been loaded otherwise) – while <em>not</em> in <code>dev_mode</code>, then you’ll get whatever version of the package may be installed in your library tree, not this development version.</p>
<p>If you want to switch between versions of <strong>optmatch</strong>, we suggest re-starting R.</p>
</div>
</div>
<div class="section level2">
<h2 id="developing-for-optmatch">Developing for <strong>optmatch</strong>
<a class="anchor" aria-label="anchor" href="#developing-for-optmatch"></a>
</h2>
<p>You may use RStudio to develop for <strong>optmatch</strong>, by opening the <code>optmatch.Rproj</code> file. We suggest you ensure all required dependencies are installed by running</p>
<pre class="{r}"><code><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_deps</span><span class="op">(</span>dependencies <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre>
<p>We prefer changes that include unit tests demonstrating the problem or showing how the new feature should be added. The test suite uses the <a href="https://github.com/hadley/test_that" class="external-link">testthat</a> package to write and run tests. (Please ensure you have the latest version of testthat (or at least v0.11.0), as older versions stored the tests in a different directory, and may not test properly.) See the <code>tests/testthat</code> directory for examples. You can run the test suite via Build -&gt; Test Package.</p>
<p>New features should include inline <a href="http://roxygen.org/" class="external-link">Roxygen</a> documentation. You can generate all <code>.Rd</code> documents from the <code>Roxygen</code> code using Build -&gt; Document.</p>
<p>Finally, you can use Build -&gt; Build and Reload or Build -&gt; Clean and Rebuild to load an updated version of <strong>optmatch</strong> in your current RStudio session. Alternatively, to install the developed version permanently, use Build -&gt; Build Binary Version, followed by</p>
<pre class="{r}"><code><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"../optmatch_VERSION.tgz"</span>, repo<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></code></pre>
<p>You can revert back to the current CRAN version by</p>
<pre class="{r}"><code><span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html" class="external-link">remove.packages</a></span><span class="op">(</span><span class="st">"optmatch"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"optmatch"</span><span class="op">)</span></code></pre>
<p>Note: If you are building for release on CRAN, you need to ensure vignettes are compacted. This should be enabled automatically in the .Rproj file, but if not see <a href="https://stackoverflow.com/a/53706965/905101" class="external-link">this stackoverflow answer</a> for some concerns about dealing with this with RStudio.</p>
<p>If you prefer not to use RStudio, you can develop using Make.</p>
<ul>
<li>
<code>make test</code>: Run the full test suite.</li>
<li>
<code>make document</code>: Update all documentation from Roxygen inline comments.</li>
<li>
<code>make interactive</code>: Start up an interactive session with <strong>optmatch</strong> loaded. (<code>make interactive-emacs</code> will start the session inside emacs.)</li>
<li>
<code>make check</code>: Run <code>R CMD check</code> on the package</li>
<li>
<code>make build</code>: Build a binary package.</li>
<li>
<code>make vignette</code>: Builds any vignettes in <code>vignettes/</code> directory</li>
<li>
<code>make clean</code>: Removes files built by <code>make vignette</code>, <code>make document</code> or <code>make check</code>. Should not be generally necessary, but can be useful for debugging.</li>
<li>
<code>make release</code>: Starts an interactive R session to submit a release to CRAN.</li>
</ul>
<p>When your change is ready, make a pull request on github.</p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=optmatch" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/markmfredrickson/optmatch/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/markmfredrickson/optmatch/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing optmatch</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Ben Hansen <br><small class="roles"> Author </small>  </li>
<li>Mark Fredrickson <br><small class="roles"> Author </small>  </li>
<li>Josh Errickson <br><small class="roles"> Maintainer, author </small>  </li>
<li>Josh Buckner <br><small class="roles"> Author </small>  </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=optmatch" class="external-link"><img src="https://www.r-pkg.org/badges/version/optmatch" alt="CRAN_Status_Badge"></a></li>
<li><a href="https://github.com/markmfredrickson/optmatch/actions" class="external-link"><img src="https://github.com/markmfredrickson/optmatch/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ben Hansen, Mark Fredrickson, Josh Errickson, Josh Buckner.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
